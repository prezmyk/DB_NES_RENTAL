<?xml version = '1.0' encoding = 'UTF-8'?>
<PackageOracle class="oracle.dbtools.crest.model.design.storage.oracle.PackageOracle" name="cart_rent_pkg" directorySegmentName="seg_0" id="B1BCEBC8-0A8B-A9CB-1D96-AEC81B440165">
<createdBy>PzK</createdBy>
<createdTime>2022-07-25 18:00:02 UTC</createdTime>
<ownerDesignName>nes_rental_shop</ownerDesignName>
<source>create or replace PACKAGE cart_rent_pkg IS

   TYPE cart_array IS TABLE OF INTEGER INDEX BY BINARY_INTEGER;

   PROCEDURE cart_rent ( p_cartridge_id cart_array, p_customer_id NUMBER); 

    v_employee_id NUMBER;
    v_rental_id NUMBER;
    v_availability VARCHAR2(1);
    -- v_reservation reservations%rowtype;

END cart_rent_pkg;

create or replace PACKAGE BODY cart_rent_pkg IS  

     PROCEDURE cart_rent ( p_cartridge_id cart_array, p_customer_id NUMBER) AS
BEGIN
            SELECT employee_id INTO v_employee_id FROM employees
            WHERE user = ( SELECT user FROM dual);  -- employee_id finding select

            INSERT INTO rentals (  customer_id, employee_id)  -- Creating rental record
                         VALUES (  p_customer_id, v_employee_id );

            v_rental_id := ISEQ$$_76661.currval; -- Rentals table rental_id sequence  generated by system

           --SELECT customer_id INTO v_reservation FROM RESERVATIONS -- declare collection for many reservations 
          --WHERE customer_id = p_customer_id;
    
            FOR i IN p_cartridge_id.first .. p_cartridge_id.last -- Cartridges loop
            LOOP
                SELECT cartridges.availability INTO v_availability FROM cartridges 
                WHERE cartridge_id = p_cartridge_id(i); -- Check cartridge is available

                IF  v_availability = &apos;Y&apos; THEN 
                    INSERT INTO cartridges_rentals(rental_id, cartridge_id)
                    VALUES (v_rental_id, p_cartridge_id(i) ); -- IF yes then rent

                  UPDATE cartridges -- SET availability to N if YES 
                  SET availability = &apos;N&apos; WHERE cartridge_id = p_cartridge_id(i);      

               /* ELSIF v_availability = &apos;R&apos; AND v_reservation  = p_customer_id THEN
                    -- declare collection and use loop for many rexervations
                    INSERT INTO cartridges_rentals(rental_id, cartridge_id)
                    VALUES                      (v_rental_id, p_cartridge_id ); -- IF yes then rent

                    DELETE FROM reservations WHERE cartridge_id = p_cartridge_id; -- Delete reservation
                    -- Availibility on cartridge table changes au_reservations trigger; */
                ELSE
                    CONTINUE;
                END IF;
            END LOOP; 
END;
END cart_rent_pkg;</source>
</PackageOracle>